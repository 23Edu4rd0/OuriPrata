{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.nome }} - OuriPrata{% endblock %}
{% block meta_description %}<meta name="description" content="{{ product.descricao|truncatewords:20 }}">{% endblock %}
{% block og_title %}{{ product.nome }} - OuriPrata{% endblock %}
{% block og_description %}{{ product.descricao|truncatewords:20 }}{% endblock %}
{% block og_image %}{{ product.imagem.url }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'assets/css/reviews.css' %}?v=17">
<link rel="stylesheet" href="{% static 'assets/css/image-viewer.css' %}?v=17">
{% endblock %}

{% block content %}
{% csrf_token %}

<style>
/* Breadcrumb moderno */
.breadcrumb {
  background: none;
  padding: 0;
  margin: 0;
  font-size: 0.875rem;
}

/* Modal de avaliação simples */
.review-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.review-modal-content {
  background-color: white;
  margin: 5% auto;
  padding: 0;
  border-radius: 8px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.review-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #dee2e6;
  background-color: #f8f9fa;
  border-radius: 8px 8px 0 0;
}

.review-modal-header h5 {
  margin: 0;
  font-weight: bold;
}

.close-btn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #6c757d;
}

.close-btn:hover {
  color: #dc3545;
}

.review-modal-body {
  padding: 20px;
}

.review-modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  padding: 20px;
  border-top: 1px solid #dee2e6;
  background-color: #f8f9fa;
  border-radius: 0 0 8px 8px;
}

/* Sistema de estrelas de rating */
.rating-stars {
  display: flex;
  gap: 8px;
  margin: 15px 0;
}

.star-btn {
  background: none;
  border: none;
  font-size: 2.5rem;
  color: #dee2e6;
  cursor: pointer;
  transition: all 0.2s ease;
  padding: 5px;
  line-height: 1;
}

.star-btn:hover {
  color: #ffc107;
  transform: scale(1.1);
}

.star-btn.selected {
  color: #ffc107;
}

.star-btn.selected:hover {
  color: #ffc107;
}

.star-btn:focus {
  outline: none;
  box-shadow: none;
}

/* Modal customizado */
#reviewModal {
  z-index: 9999 !important;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: none;
  background-color: transparent;
}

#reviewModal.show {
  display: flex !important;
  align-items: center;
  justify-content: center;
}

#reviewModal .modal-dialog {
  z-index: 10000 !important;
  position: relative;
  pointer-events: auto;
  background-color: white;
  border-radius: 0.375rem;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

#reviewModal .modal-content {
  pointer-events: auto;
  background-color: white;
}

#customBackdrop {
  z-index: 9998 !important;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0, 0, 0, 0.5);
  pointer-events: none;
}

.breadcrumb-item {
  display: flex;
  align-items: center;
}

.breadcrumb-item + .breadcrumb-item::before {
  content: "›";
  color: #6c757d;
  font-size: 1.1rem;
  font-weight: 300;
  margin: 0 8px;
}

.breadcrumb-item a {
  color: #6c757d;
  text-decoration: none;
  font-weight: 400;
  transition: all 0.2s ease;
  position: relative;
}

.breadcrumb-item a:hover {
  color: #ffc107;
  transform: translateY(-1px);
}

.breadcrumb-item a::after {
  content: '';
  position: absolute;
  width: 0;
  height: 1px;
  bottom: -2px;
  left: 0;
  background-color: #ffc107;
  transition: width 0.3s ease;
}

.breadcrumb-item a:hover::after {
  width: 100%;
}

.breadcrumb-item.active {
  color: #343a40;
  font-weight: 500;
}

/* Imagem principal responsiva */
#main-product-image {
  height: 400px !important;
  object-fit: cover !important;
  width: 100% !important;
}

@media (max-width: 576px) {
  #main-product-image {
    height: 250px !important;
  }
  
  .card-img-top {
    height: 120px !important;
  }
  .card-body {
    padding: 0.75rem !important;
  }
  .card-title {
    font-size: 0.85rem !important;
  }
  .btn {
    font-size: 0.8rem !important;
    padding: 0.375rem 0.75rem !important;
  }
}

@media (min-width: 577px) and (max-width: 768px) {
  #main-product-image {
    height: 350px !important;
  }
  
  .card-img-top {
    height: 150px !important;
  }
}

@media (min-width: 769px) and (max-width: 991px) {
  #main-product-image {
    height: 380px !important;
  }
}

@media (min-width: 992px) {
  #main-product-image {
    height: 450px !important;
  }
}

@media (max-width: 576px) {
  .breadcrumb {
    font-size: 0.8rem !important;
  }
  .breadcrumb-item + .breadcrumb-item::before {
    font-size: 0.9rem !important;
    margin: 0 6px !important;
  }
}
  
  /* Responsividade para seletor de tamanho */
  #ring-size {
    font-size: 0.8rem !important;
    min-width: 80px !important;
  }
  
  .modal-dialog {
    margin: 0.5rem !important;
  }
  
  .table-responsive {
    font-size: 0.75rem !important;
  }
  
  .modal-body .row .col-md-4,
  .modal-body .row .col-md-6 {
    margin-bottom: 1rem;
  }
}

@media (min-width: 577px) and (max-width: 768px) {
  #main-product-image {
    height: 300px !important;
  }
  
  #ring-size {
    min-width: 90px !important;
  }
}

/* Estilos para validação */
.is-invalid {
  border-color: #dc3545 !important;
  box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

/* Animação suave para alertas */
.alert {
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Animação para o badge do carrinho */
@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0) translateX(-50%);
  }
  40% {
    transform: translateY(-10px) translateX(-50%);
  }
  60% {
    transform: translateY(-5px) translateX(-50%);
  }
}

/* Efeitos de hover para botões */
.btn-warning:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
  transition: all 0.2s ease;
}

.btn-outline-danger:hover {
  transform: translateY(-1px);
  transition: all 0.2s ease;
}

/* Destaque para passos de compra */
.bg-warning .rounded-circle {
  transition: all 0.3s ease;
}

.bg-warning .rounded-circle:hover {
  transform: scale(1.1);
}

/* Animação de loading */
.spin {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Animação para o modal */
.modal-content {
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Forçar texto branco no botão de wishlist quando ativo */
#wishlist-btn.btn-danger,
#wishlist-btn.btn-danger:hover,
#wishlist-btn.btn-danger:focus,
#wishlist-btn.btn-danger:active {
  color: white !important;
  background-color: #dc3545 !important;
  border-color: #dc3545 !important;
}

#wishlist-btn.btn-danger:hover {
  background-color: #c82333 !important;
  border-color: #bd2130 !important;
}

/* Auto-hide para alertas */
.alert.auto-hide {
  animation: alertAutoHide 3.5s ease-out forwards;
}

@keyframes alertAutoHide {
  0% {
    opacity: 1;
    transform: translateY(0);
    visibility: visible;
  }
  85.7% {  /* 3s de 3.5s = 85.7% */
    opacity: 1;
    transform: translateY(0);
    visibility: visible;
  }
  100% {
    opacity: 0;
    transform: translateY(-10px);
    visibility: hidden;
  }
}

/* Sobrescrevendo transições do Bootstrap para alertas auto-hide */
.alert.auto-hide.fade {
  transition: none !important;
}

.alert.auto-hide.show {
  opacity: 1 !important;
}

/* Alertas modernos responsivos */
@media (max-width: 576px) {
  #alert-container {
    top: 10px !important;
    right: 10px !important;
    left: 10px !important;
    max-width: none !important;
  }
}

/* Animação suave para alertas modernos */
@keyframes slideInFromRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutToRight {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}
</style>

<main class="container py-2 py-md-4">

  <div class="row g-2 g-md-4">
    <div class="col-12 col-lg-6">
      <div class="position-sticky" style="top: 2rem;">
        <div class="card border-0 shadow-sm">
          <div class="position-relative overflow-hidden" style="min-height: 400px;">
            <img id="main-product-image" 
                 src="{{ product.imagem.url }}" 
                 class="card-img-top" 
                 alt="{{ product.nome }}" 
                 style="cursor: zoom-in;">
            
            {% if product.em_promocao and product.preco_promocional %}
            <span class="position-absolute top-0 end-0 m-1 m-md-3 badge bg-danger px-1 px-md-3 py-0 py-md-2 rounded-pill">
              <i class="bi bi-lightning-fill me-1"></i>Oferta
            </span>
            {% endif %}
          </div>
          
          <div class="card-body p-1 p-md-3">
            <div class="d-flex gap-1 gap-md-2 justify-content-center">
              <!-- Imagem principal -->
              <img src="{{ product.imagem.url }}" 
                   class="rounded border product-thumb" 
                   style="width: 50px; height: 50px; object-fit: cover; cursor: pointer; opacity: 0.7;"
                   onclick="changeMainImage(this.src, event)">
              <!-- Imagens extras -->
              {% for img in product.imagens_extra.all %}
                <img src="{{ img.imagem.url }}"
                     class="rounded border product-thumb"
                     style="width: 50px; height: 50px; object-fit: cover; cursor: pointer; opacity: 0.7;"
                     onclick="changeMainImage(this.src, event)">
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="mb-2 mb-md-4">
        <h1 class="h5 fw-bold text-dark mb-2 mb-md-3">{{ product.nome }}</h1>
        
        <div class="mb-2 mb-md-4">
          {% if product.em_promocao and product.preco_promocional %}
            <div class="d-flex align-items-center gap-1 gap-md-3 mb-1 mb-md-2">
              <span class="text-muted text-decoration-line-through h6">R$ {{ product.preco }}</span>
              <span class="text-danger h5 fw-bold mb-0">R$ {{ product.preco_promocional }}</span>
            </div>
            <small class="text-danger fw-semibold">
              <i class="bi bi-arrow-down me-1"></i>
              {% widthratio product.preco_promocional product.preco 100 as discount %}
              {{ discount|floatformat:0 }}% OFF
            </small>
          {% else %}
            <span class="text-dark h5 fw-bold">R$ {{ product.preco }}</span>
          {% endif %}
        </div>

        <div class="mb-2 mb-md-4">
          <h5 class="fw-semibold mb-1 mb-md-2" style="font-size: 0.9rem;">Descrição</h5>
          <p class="text-muted" style="font-size: 0.85rem; line-height: 1.5;">
            {{ product.descricao|default:"Este produto não possui descrição." }}
          </p>
        </div>

        <!-- Seletor de Tamanho (para anéis, alargadores, etc.) -->
        {% if product.categoria.nome|lower in "anéis,anel,alargador,alargadores,aliança,alianças" or "anel" in product.categoria.nome|lower or "alargador" in product.categoria.nome|lower %}
        <div class="mb-3 mb-md-4">
          <div class="d-flex align-items-center gap-1 gap-md-2 mb-1 mb-md-2">
            <h5 class="fw-semibold mb-0" style="font-size: 0.9rem;">Tamanho do Dedo</h5>
            <button type="button" class="btn btn-link p-0 text-decoration-none" onclick="openSizeGuideModal()">
              <small class="text-primary">
                <i class="bi bi-info-circle me-1"></i>Como medir?
              </small>
            </button>
          </div>
          
          <div class="row g-1 g-md-2">
            <div class="col-auto">
              <select class="form-select form-select-sm" id="ring-size" name="ring_size" style="min-width: 100px;" required>
                <option value="">Selecione</option>
                <option value="12">12 (52mm)</option>
                <option value="13">13 (53mm)</option>
                <option value="14">14 (54mm)</option>
                <option value="15">15 (55mm)</option>
                <option value="16">16 (56mm)</option>
                <option value="17">17 (57mm)</option>
                <option value="18">18 (58mm)</option>
                <option value="19">19 (59mm)</option>
                <option value="20">20 (60mm)</option>
                <option value="21">21 (61mm)</option>
                <option value="22">22 (62mm)</option>
                <option value="23">23 (63mm)</option>
                <option value="24">24 (64mm)</option>
                <option value="25">25 (65mm)</option>
                <option value="26">26 (66mm)</option>
                <option value="27">27 (67mm)</option>
                <option value="28">28 (68mm)</option>
              </select>
            </div>
            <div class="col-auto">
              <small class="text-muted">Tamanho brasileiro</small>
            </div>
          </div>
          
          <div class="mt-2">
            <small class="text-muted">
              <i class="bi bi-exclamation-circle me-1"></i>
              Não sabe seu tamanho? Use nosso guia para medir corretamente.
            </small>
          </div>
        </div>
        {% endif %}

        <!-- Seção de Compra Sofisticada -->
        <div class="mb-4">
          <div class="row g-3 align-items-end">
            <div class="col-auto">
              <div class="d-flex align-items-center border rounded">
                <button class="btn btn-sm border-0" type="button" onclick="decreaseQuantity()">
                  <i class="bi bi-dash"></i>
                </button>
                <input type="number" 
                       value="1" 
                       min="1" 
                       max="5" 
                       class="form-control border-0 text-center" 
                       id="quantity-input" 
                       style="width: 50px; box-shadow: none;">
                <button class="btn btn-sm border-0" type="button" onclick="increaseQuantity()">
                  <i class="bi bi-plus"></i>
                </button>
              </div>
            </div>
            
            <div class="col">
              <button id="add-to-cart-btn" 
                      class="btn btn-dark text-white fw-medium py-3 w-100 border-0" 
                      data-produto-id="{{ product.id }}"
                      style="letter-spacing: 0.5px;">
                <i class="bi bi-bag me-2"></i>
                Adicionar ao Carrinho
              </button>
            </div>
          </div>
        </div>

        <!-- Ações Secundárias -->
        <div class="d-flex gap-3 mb-4">
          {% if user.is_authenticated %}
            <button id="wishlist-btn" 
                    class="btn btn-outline-secondary flex-fill py-2" 
                    data-produto-id="{{ product.id }}"
                    style="border-color: #e9ecef;">
              <i class="bi bi-heart" id="wishlist-icon"></i>
              <span id="wishlist-text" class="ms-2 d-none d-md-inline">Lista de Desejos</span>
            </button>
          {% else %}
            <a href="{% url 'accounts:login' %}" 
               class="btn btn-outline-secondary flex-fill py-2"
               style="border-color: #e9ecef;">
              <i class="bi bi-heart me-2"></i>
              <span class="d-none d-md-inline">Lista de Desejos</span>
            </a>
          {% endif %}
          
          <button class="btn btn-outline-secondary px-4 py-2" 
                  onclick="shareProduct()"
                  style="border-color: #e9ecef;">
            <i class="bi bi-share"></i>
          </button>
        </div>

        <!-- Informações Essenciais -->
        <div class="border-top pt-4 mb-5">
          <div class="row g-4 text-center">
            <div class="col-6 col-md-3">
              <i class="bi bi-truck text-muted mb-2 d-block" style="font-size: 1.2rem;"></i>
              <small class="text-muted">Frete Grátis</small>
            </div>
            <div class="col-6 col-md-3">
              <i class="bi bi-shield-check text-muted mb-2 d-block" style="font-size: 1.2rem;"></i>
              <small class="text-muted">Garantia</small>
            </div>
            <div class="col-6 col-md-3">
              <i class="bi bi-arrow-repeat text-muted mb-2 d-block" style="font-size: 1.2rem;"></i>
              <small class="text-muted">Troca Grátis</small>
            </div>
            <div class="col-6 col-md-3">
              <i class="bi bi-credit-card text-muted mb-2 d-block" style="font-size: 1.2rem;"></i>
              <small class="text-muted">Pix/Cartão</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <section class="py-5">
    <div class="container">
      <div class="text-center mb-4">
        <h2 class="h3 fw-bold text-dark mb-2">Produtos Relacionados</h2>
        <p class="text-muted small">Outras peças que você pode gostar</p>
        <div class="mx-auto bg-warning rounded-pill" style="height: 3px; width: 60px;"></div>
      </div>

      <div class="row g-3">
        {% for product in related_products %}
        <div class="col-lg-3 col-md-6 col-6">
          <div class="card border-0 h-100 shadow-sm">
            <div class="position-relative overflow-hidden">
              <img class="card-img-top" 
                   src="{% if product.imagem %}{{ product.imagem.url }}{% else %}{% static 'assets/landing_page/logo.png' %}{% endif %}" 
                   alt="{{ product.nome }}" 
                   style="height: 250px; object-fit: cover;">
              <!-- Aqui as subimagens -->
              <div class="d-flex justify-content-center gap-2 mt-2">
                {% for subimg in product.joaisimagem_set.all %}
                  <img src="{{ subimg.imagem.url }}" alt="Subimagem de {{ product.nome }}" style="width: 48px; height: 48px; object-fit: cover; border-radius: 6px; border: 1px solid #eee;">
                {% endfor %}
              </div>
            </div>
            
            <div class="card-body text-center p-2">
              <h5 class="card-title fw-bold mb-2" style="font-size: 0.9rem; min-height: 2.5rem; display: flex; align-items: center; justify-content: center;">
                {{ product.nome }}
              </h5>
              
              <div class="mb-2" style="min-height: 2rem; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                {% if product.em_promocao and product.preco_promocional %}
                  <div class="d-flex justify-content-center align-items-center gap-1">
                    <span class="text-muted text-decoration-line-through" style="font-size: 0.8rem;">
                      R$ {{ product.preco|floatformat:2 }}
                    </span>
                    <span class="fw-bold text-danger mb-0" style="font-size: 0.95rem;">
                      R$ {{ product.preco_promocional|floatformat:2 }}
                    </span>
                  </div>
                  <small class="text-danger fw-semibold" style="font-size: 0.75rem;">
                    <i class="bi bi-arrow-down me-1"></i>
                    {% widthratio product.preco_promocional product.preco 100 as discount %}
                    {{ discount|floatformat:0 }}% OFF
                  </small>
                {% else %}
                  <span class="fw-bold text-dark mb-0" style="font-size: 0.95rem;">
                    R$ {{ product.preco|floatformat:2 }}
                  </span>
                {% endif %}
              </div>
              
              <a href="{% url 'product_detail' product.slug %}" 
                 class="btn btn-outline-warning px-2 py-1 rounded-pill fw-semibold" 
                 style="font-size: 0.8rem;">
                Ver Detalhes
              </a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- Seção de Avaliações -->
  <section class="py-5">
    <div class="container">
      <div class="text-center mb-5">
        <h2 class="fw-bold text-dark mb-2">Avaliações dos Clientes</h2>
        <p class="text-muted">O que nossos clientes dizem sobre este produto</p>
        <div class="bg-warning" style="width: 60px; height: 3px; margin: 0 auto;"></div>
      </div>

      <div class="row g-4">
        <!-- Distribuição das Avaliações - Coluna Esquerda -->
        <div class="col-lg-3 col-12 mb-4">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <h6 class="text-dark mb-3">Distribuição das Avaliações</h6>
              
              <!-- Design equilibrado -->
              <div class="rating-balanced">
                <!-- 5 estrelas -->
                <div class="rating-item mb-3">
                  <div class="d-flex align-items-center">
                    <span class="text-warning me-2">★★★★★</span>
                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                      <div class="progress-bar bg-warning" role="progressbar" 
                           style="width: {{ rating_percentages.5|floatformat:1 }}%;"></div>
                    </div>
                    <small class="text-muted">{{ rating_distribution.5|default:"0" }}</small>
                  </div>
                </div>
                
                <!-- 4 estrelas -->
                <div class="rating-item mb-3">
                  <div class="d-flex align-items-center">
                    <span class="text-warning me-2">★★★★☆</span>
                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                      <div class="progress-bar bg-warning" role="progressbar" 
                           style="width: {{ rating_percentages.4|floatformat:1 }}%;"></div>
                    </div>
                    <small class="text-muted">{{ rating_distribution.4|default:"0" }}</small>
                  </div>
                </div>
                
                <!-- 3 estrelas -->
                <div class="rating-item mb-3">
                  <div class="d-flex align-items-center">
                    <span class="text-warning me-2">★★★☆☆</span>
                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                      <div class="progress-bar bg-warning" role="progressbar" 
                           style="width: {{ rating_percentages.3|floatformat:1 }}%;"></div>
                    </div>
                    <small class="text-muted">{{ rating_distribution.3|default:"0" }}</small>
                  </div>
                </div>
                
                <!-- 2 estrelas -->
                <div class="rating-item mb-3">
                  <div class="d-flex align-items-center">
                    <span class="text-warning me-2">★★☆☆☆</span>
                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                      <div class="progress-bar bg-warning" role="progressbar" 
                           style="width: {{ rating_percentages.2|floatformat:1 }}%;"></div>
                    </div>
                    <small class="text-muted">{{ rating_distribution.2|default:"0" }}</small>
                  </div>
                </div>
                
                <!-- 1 estrela -->
                <div class="rating-item mb-3">
                  <div class="d-flex align-items-center">
                    <span class="text-warning me-2">★☆☆☆☆</span>
                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                      <div class="progress-bar bg-warning" role="progressbar" 
                           style="width: {{ rating_percentages.1|floatformat:1 }}%;"></div>
                    </div>
                    <small class="text-muted">{{ rating_distribution.1|default:"0" }}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Comentários dos Clientes - Coluna Central -->
        <div class="col-lg-6 col-md-8 col-12 mb-4">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <h5 class="card-title fw-bold text-dark mb-3">Comentários dos Clientes</h5>
              <div class="reviews-container">
                {% if reviews %}
                  {% for review in reviews %}
                    <div class="review-item border-bottom pb-3 mb-3">
                      <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                          <h6 class="fw-bold mb-1">{{ review.usuario.first_name|default:review.usuario.username }}</h6>
                          <div class="text-warning mb-2">
                            <span>★</span>
                            <span>★</span>
                            <span>★</span>
                            <span class="text-muted">★</span>
                            <span class="text-muted">★</span>
                          </div>
                        </div>
                        <small class="text-muted">{{ review.data_criacao|date:"d/m/Y" }}</small>
                      </div>
                      
                      <p class="text-dark mb-2">{{ review.comentario }}</p>
                      
                      <!-- Imagens do Comentário -->
                      {% if review.imagens.all %}
                        <div class="mt-2">
                          <div class="d-flex gap-1 flex-wrap">
                            {% for review_image in review.imagens.all %}
                              <div class="position-relative">
                                <img src="{{ review_image.imagem.url }}" 
                                     alt="Imagem do comentário" 
                                     class="rounded" 
                                     style="width: 60px; height: 60px; object-fit: cover; cursor: pointer; border: 1px solid #e0e0e0; background-color: white;"
                                     onclick="showImageFullscreen('{{ review_image.imagem.url }}', '{{ review.usuario.first_name|default:review.usuario.username }}')"
                                     title="Clique para ampliar">
                              </div>
                            {% endfor %}
                          </div>
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="text-center text-muted py-4">
                    <i class="fas fa-comments fa-3x mb-3"></i>
                    <p>Nenhuma avaliação ainda. Seja o primeiro a avaliar!</p>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Botões de Ação - Coluna Direita -->
        <div class="col-lg-3 col-12">
          <div class="d-flex flex-column gap-3">
            {% if user.is_authenticated %}
              {% if user_review %}
                <button class="btn btn-primary w-100" onclick="editReview()">
                  <i class="fas fa-edit me-2"></i>Editar Avaliação
                </button>
                <button class="btn btn-danger w-100" onclick="deleteReview()">
                  <i class="fas fa-trash me-2"></i>Apagar Avaliação
                </button>
              {% else %}
                <button class="btn btn-success w-100" onclick="showReviewForm()">
                  <i class="fas fa-star me-2"></i>Avaliar Produto
                </button>
              {% endif %}
            {% else %}
              <div class="text-center">
                <p class="text-muted mb-3">Faça login para avaliar este produto</p>
                <a href="{% url 'accounts:login' %}" class="btn btn-outline-primary w-100">
                  <i class="fas fa-sign-in-alt me-2"></i>Fazer Login
                </a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal de Produto Adicionado -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-success text-white border-0">
          <h5 class="modal-title fw-bold" id="cartModalLabel">
            <i class="bi bi-check-circle-fill me-2"></i>
            Adicionado ao Carrinho
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center py-4">
          <div class="mb-3">
            <i class="bi bi-cart-check-fill text-success" style="font-size: 3.5rem;"></i>
          </div>
          <h6 class="fw-bold mb-4" id="productAddedName">{{ product.nome }}</h6>
          
          <div class="row g-2 mb-4">
            <div class="col-12">
              <button type="button" class="btn btn-warning btn-lg fw-bold w-100" onclick="goToCart()">
                <i class="bi bi-credit-card me-2"></i>
                Finalizar Compra
              </button>
            </div>
            <div class="col-12">
              <button type="button" class="btn btn-outline-secondary w-100" data-bs-dismiss="modal">
                <i class="bi bi-arrow-left me-2"></i>
                Continuar Navegando
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal - Guia de Tamanhos (Simplificado) -->
  <div id="sizeGuideModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; border-radius: 8px; max-width: 90%; max-height: 90%; overflow-y: auto; width: 800px;">
      <div style="padding: 1rem 1.5rem; background-color: #ffc107; color: #000; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;">
        <h5 style="margin: 0; font-weight: bold;">
          <i class="bi bi-ruler me-2"></i>Como Medir o Tamanho do Dedo
        </h5>
        <button type="button" onclick="closeSizeGuideModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #000; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">×</button>
      </div>
      <div style="padding: 1.5rem;">
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
          <!-- Método 1 -->
          <div style="flex: 1; background-color: #f8f9fa; padding: 1rem; border-radius: 8px;">
            <h6 style="color: #ffc107; font-weight: bold; margin-bottom: 1rem;">
              <i class="bi bi-1-circle me-2"></i>Método da Fita
            </h6>
            <ol style="font-size: 0.9rem;">
              <li style="margin-bottom: 0.5rem;">Corte uma tira de papel ou use uma fita métrica</li>
              <li style="margin-bottom: 0.5rem;">Enrole ao redor do dedo onde ficará o anel</li>
              <li style="margin-bottom: 0.5rem;">Marque onde a fita se encontra</li>
              <li style="margin-bottom: 0.5rem;">Meça o comprimento com uma régua (em mm)</li>
              <li>Compare com a tabela abaixo</li>
            </ol>
            <div style="background-color: #d1ecf1; color: #0c5460; padding: 0.5rem; border-radius: 4px; margin-top: 1rem;">
              <small>
                <i class="bi bi-info-circle me-1"></i>
                <strong>Dica:</strong> Meça no final do dia quando o dedo está mais inchado
              </small>
            </div>
          </div>

          <!-- Método 2 -->
          <div style="flex: 1; background-color: #f8f9fa; padding: 1rem; border-radius: 8px;">
            <h6 style="color: #ffc107; font-weight: bold; margin-bottom: 1rem;">
              <i class="bi bi-2-circle me-2"></i>Método do Anel
            </h6>
            <ol style="font-size: 0.9rem;">
              <li style="margin-bottom: 0.5rem;">Pegue um anel que já serve no dedo</li>
              <li style="margin-bottom: 0.5rem;">Meça o diâmetro interno com uma régua</li>
              <li style="margin-bottom: 0.5rem;">Multiplique por 3,14 para obter a circunferência</li>
              <li style="margin-bottom: 0.5rem;">Compare com a tabela abaixo</li>
            </ol>
            <div style="background-color: #fff3cd; color: #856404; padding: 0.5rem; border-radius: 4px; margin-top: 1rem;">
              <small>
                <i class="bi bi-exclamation-triangle me-1"></i>
                <strong>Atenção:</strong> Use um anel que sirva perfeitamente, nem apertado nem folgado
              </small>
            </div>
          </div>
        </div>

        <!-- Tabela de Tamanhos -->
        <div style="margin-top: 1.5rem;">
          <h6 style="font-weight: bold; text-align: center; margin-bottom: 1rem;">Tabela de Tamanhos Brasileiros</h6>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; text-align: center; font-size: 0.85rem;">
              <thead style="background-color: #ffc107;">
                <tr>
                  <th style="padding: 0.5rem; border: 1px solid #dee2e6;">Tamanho BR</th>
                  <th style="padding: 0.5rem; border: 1px solid #dee2e6;">Circunferência (mm)</th>
                  <th style="padding: 0.5rem; border: 1px solid #dee2e6;">Diâmetro (mm)</th>
                  <th style="padding: 0.5rem; border: 1px solid #dee2e6;">Tamanho US</th>
                </tr>
              </thead>
              <tbody>
                <tr style="background-color: #f8f9fa;"><td style="padding: 0.5rem; border: 1px solid #dee2e6;">12</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">52</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">16.5</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">6</td></tr>
                <tr><td style="padding: 0.5rem; border: 1px solid #dee2e6;">13</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">53</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">16.9</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">6.25</td></tr>
                <tr style="background-color: #f8f9fa;"><td style="padding: 0.5rem; border: 1px solid #dee2e6;">14</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">54</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">17.2</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">6.5</td></tr>
                <tr><td style="padding: 0.5rem; border: 1px solid #dee2e6;">15</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">55</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">17.5</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">7</td></tr>
                <tr style="background-color: #f8f9fa;"><td style="padding: 0.5rem; border: 1px solid #dee2e6;">16</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">56</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">17.8</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">7.25</td></tr>
                <tr><td style="padding: 0.5rem; border: 1px solid #dee2e6;">17</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">57</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">18.1</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">7.5</td></tr>
                <tr style="background-color: #f8f9fa;"><td style="padding: 0.5rem; border: 1px solid #dee2e6;">18</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">58</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">18.5</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">8</td></tr>
                <tr><td style="padding: 0.5rem; border: 1px solid #dee2e6;">19</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">59</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">18.8</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">8.5</td></tr>
                <tr style="background-color: #f8f9fa;"><td style="padding: 0.5rem; border: 1px solid #dee2e6;">20</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">60</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">19.1</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">9</td></tr>
                <tr><td style="padding: 0.5rem; border: 1px solid #dee2e6;">21</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">61</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">19.4</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">9.25</td></tr>
                <tr style="background-color: #f8f9fa;"><td style="padding: 0.5rem; border: 1px solid #dee2e6;">22</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">62</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">19.7</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">9.5</td></tr>
                <tr><td style="padding: 0.5rem; border: 1px solid #dee2e6;">23</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">63</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">20.1</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">10</td></tr>
                <tr style="background-color: #f8f9fa;"><td style="padding: 0.5rem; border: 1px solid #dee2e6;">24</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">64</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">20.4</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">10.5</td></tr>
                <tr><td style="padding: 0.5rem; border: 1px solid #dee2e6;">25</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">65</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">20.7</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">11</td></tr>
                <tr style="background-color: #f8f9fa;"><td style="padding: 0.5rem; border: 1px solid #dee2e6;">26</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">66</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">21.0</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">11.5</td></tr>
                <tr><td style="padding: 0.5rem; border: 1px solid #dee2e6;">27</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">67</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">21.3</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">12</td></tr>
                <tr style="background-color: #f8f9fa;"><td style="padding: 0.5rem; border: 1px solid #dee2e6;">28</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">68</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">21.6</td><td style="padding: 0.5rem; border: 1px solid #dee2e6;">12.5</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Dicas Importantes -->
        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
          <div style="flex: 1; text-align: center;">
            <i class="bi bi-thermometer-sun" style="color: #ffc107; font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <h6 style="font-size: 0.9rem; font-weight: bold; margin-bottom: 0.5rem;">Melhor Horário</h6>
            <small style="color: #6c757d;">Meça no final do dia quando o dedo está ligeiramente inchado</small>
          </div>
          <div style="flex: 1; text-align: center;">
            <i class="bi bi-snow" style="color: #007bff; font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <h6 style="font-size: 0.9rem; font-weight: bold; margin-bottom: 0.5rem;">Evite o Frio</h6>
            <small style="color: #6c757d;">Não meça quando estiver com frio, pois os dedos ficam menores</small>
          </div>
          <div style="flex: 1; text-align: center;">
            <i class="bi bi-hand-index" style="color: #28a745; font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
            <h6 style="font-size: 0.9rem; font-weight: bold; margin-bottom: 0.5rem;">Dedo Correto</h6>
            <small style="color: #6c757d;">Cada dedo tem um tamanho diferente, meça o dedo correto</small>
          </div>
        </div>

        <!-- Contato para Dúvidas -->
        <div style="background-color: #d4edda; color: #155724; padding: 1rem; border-radius: 4px; margin-top: 1.5rem;">
          <div style="display: flex; align-items: center;">
            <i class="bi bi-whatsapp" style="color: #28a745; font-size: 1.5rem; margin-right: 1rem;"></i>
            <div>
              <h6 style="margin-bottom: 0.5rem;">Ainda tem dúvidas?</h6>
              <small>Entre em contato conosco pelo WhatsApp e te ajudaremos a encontrar o tamanho perfeito!</small>
              <div style="margin-top: 0.5rem;">
                <a href="https://wa.me/5537998623061?text=Olá! Preciso de ajuda para medir o tamanho do meu dedo para um anel." 
                   style="background-color: #28a745; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 4px; font-size: 0.9rem;" target="_blank">
                  <i class="bi bi-whatsapp me-1"></i>Falar no WhatsApp
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div style="padding: 1rem 1.5rem; border-top: 1px solid #dee2e6; text-align: right;">
        <button type="button" onclick="closeSizeGuideModal()" style="background-color: #6c757d; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Avaliação Simples -->
  <div id="reviewModal" class="review-modal">
    <div class="review-modal-content">
      <div class="review-modal-header">
        <h5>Avaliar {{ product.nome }}</h5>
        <button type="button" class="close-btn" onclick="closeReviewModal()">×</button>
      </div>
      <div class="review-modal-body">
        <form id="reviewForm" enctype="multipart/form-data">
          <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
          
          <div class="mb-3">
            <label class="form-label fw-semibold">Sua Avaliação</label>
            <div class="rating-stars">
              <button type="button" class="star-btn" data-value="1">★</button>
              <button type="button" class="star-btn" data-value="2">★</button>
              <button type="button" class="star-btn" data-value="3">★</button>
              <button type="button" class="star-btn" data-value="4">★</button>
              <button type="button" class="star-btn" data-value="5">★</button>
            </div>
            <input type="hidden" id="rating-input" name="rating" value="5">
          </div>
          
          <div class="mb-3">
            <label for="comment" class="form-label fw-semibold">Comentário</label>
            <textarea class="form-control" id="comment" name="comment" rows="4" placeholder="Conte sua experiência com este produto..." required></textarea>
          </div>
          
          <div class="mb-3">
            <label for="images" class="form-label fw-semibold">Fotos (opcional)</label>
            <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
            <small class="text-muted">Você pode adicionar até 5 fotos</small>
          </div>
        </form>
      </div>
      <div class="review-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeReviewModal()">Cancelar</button>
        <button type="button" class="btn btn-warning" id="submit-review-btn" onclick="submitReview()">Enviar Avaliação</button>
      </div>
    </div>
  </div>

  <!-- Modal de Imagem -->
  <!-- Modal removido - usando abordagem mais simples -->

  <script src="{% static 'assets/js/review-system.js' %}"></script>
  <script src="{% static 'assets/js/image-modal.js' %}"></script>
  
  <!-- Script para forçar cor dourada nas barras -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Aplicar estilo equilibrado com cor dourada
      const progressBars = document.querySelectorAll('.rating-balanced .progress-bar');
      progressBars.forEach(function(bar) {
        bar.style.backgroundColor = '#ffc107';
        bar.style.border = 'none';
        bar.style.boxShadow = 'none';
        bar.style.transition = 'width 0.3s ease';
      });
      
      // Também aplicar cor dourada nas estrelas
      const warningStars = document.querySelectorAll('.rating-balanced .text-warning');
      warningStars.forEach(function(star) {
        star.style.color = '#ffc107';
      });
    });
    
    // Funções para o modal de tamanho customizado
    function openSizeGuideModal() {
      const modal = document.getElementById('sizeGuideModal');
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    
    function closeSizeGuideModal() {
      const modal = document.getElementById('sizeGuideModal');
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
    
    // Fechar modal ao clicar fora dele
    document.addEventListener('click', function(event) {
      const modal = document.getElementById('sizeGuideModal');
      if (event.target === modal) {
        closeSizeGuideModal();
      }
    });
  </script>
  
  <!-- Passar dados do usuário para o JavaScript -->
  <script>
    // Dados do usuário para o sistema de reviews
    {% if user_review %}
      window.userReviewId = {{ user_review.id }};
      window.userReviewRating = {{ user_review.rating }};
      window.userReviewComment = "{{ user_review.comentario|escapejs }}";
      window.userReviewImages = [
        {% for image in user_review.imagens.all %}
          "{{ image.imagem.url|escapejs }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
      ];
    {% else %}
      window.userReviewId = null;
      window.userReviewRating = 0;
      window.userReviewComment = "";
      window.userReviewImages = [];
    {% endif %}
  </script>
</main>
{% endblock content %}

